# BTC/ETH 鎖倉Token折扣率計算器

一個專業的加密貨幣鎖倉token折扣率計算工具，使用ATM多合約加權Black-Scholes定價法，提供機會成本與保險成本的雙重分析視角。

## 核心功能

- **多幣種支援**：Bitcoin (BTC) 和 Ethereum (ETH)
- **多期限選擇**：3個月、6個月、1年、2年鎖倉期限
- **ATM多合約加權**：使用前5個最接近ATM的選擇權合約進行加權計算
- **Black-Scholes定價**：基於隱含波動率的理論期權定價模型
- **流動性權重優化**：根據bid-ask價差計算流動性評分，優化結果可靠性
- **雙重折扣分析**：同時提供Call折扣（機會成本）和Put折扣（保險成本）
- **方差外推技術**：中長期合約使用線性外推調整隱含波動率
- **實時市場數據**：CoinGecko現貨價格 + Deribit選擇權鏈完整數據
- **計算透明度**：詳細顯示ATM合約篩選、權重計算和理論定價過程
- **純數字結果**：提供客觀的計算數據，不包含投資建議

## 什麼是鎖倉Token折扣率？

鎖倉token是指在特定期間內無法自由交易的加密貨幣。由於流動性限制，這類token通常以折扣價格交易。折扣率反映了：

1. **流動性風險補償**：投資者因無法即時變現而要求的回報
2. **時間價值成本**：資金被鎖定期間的機會成本
3. **市場波動風險**：鎖倉期間價格變動的不確定性

## 計算方法：ATM多合約加權Black-Scholes定價法

**核心原理**：使用多個ATM（平價）選擇權合約，通過Black-Scholes理論定價計算Call和Put期權的機會成本與保險成本

### 理論基礎

**Black-Scholes期權定價模型**：
```
Call價格 = S×N(d₁) - K×e^(-r×T)×N(d₂)
Put價格 = K×e^(-r×T)×N(-d₂) - S×N(-d₁)

其中：
d₁ = [ln(S/K) + (r + σ²/2)×T] / (σ×√T)
d₂ = d₁ - σ×√T

S = 現貨價格, K = 執行價格, T = 到期時間
r = 無風險利率, σ = 隱含波動率, N(x) = 標準正態分佈累積函數
```

**波動率估算方法**：
- **短期（≤3個月）**：直接使用市場隱含波動率
- **中長期（3個月-1年）**：方差線性外推法
  ```
  σ²ₜₐᵣ𝓰ₑₜ = σ₁²×T₁ + (σ₂²×T₂ - σ₁²×T₁) × (Tₜₐᵣ𝓰ₑₜ - T₁)/(T₂ - T₁)
  ```

### 計算步驟

1. **ATM合約篩選**：
   - 從Deribit獲取接近鎖倉期限的選擇權合約
   - 根據|Strike - 現貨價格|選擇前5個最接近ATM的合約
   - 確保合約具有良好的流動性（較小的bid-ask價差）

2. **流動性權重計算**：
   ```
   流動性評分 = 1 / (1 + 價差率)
   價差率 = (Call價差 + Put價差) / 期權平均價格
   ```

3. **多合約Black-Scholes計算**：
   - 對每個ATM合約使用其隱含波動率計算理論期權價格
   - 中長期合約使用方差外推調整波動率
   - 計算每個合約的Call和Put折扣率

4. **加權平均折扣率**：
   ```
   Call折扣率 = Σ(個別Call折扣 × 流動性權重) / Σ流動性權重
   Put折扣率 = Σ(個別Put折扣 × 流動性權重) / Σ流動性權重
   
   Call折扣 = 理論Call價格 / 現貨價格 × 100%
   Put折扣 = 理論Put價格 / 現貨價格 × 100%
   
   年化折扣率 = Call折扣率 × (365 / 鎖倉天數)
   合理購買價格 = 現貨價格 - 加權平均Call價格
   ```

### 實際計算範例

假設我們要計算BTC 6個月鎖倉的折扣率（基於真實Deribit數據）：

**📊 市場數據**：
- 現貨價格：$113,760
- 鎖倉期限：180天（6個月，0.493年）
- 無風險利率：2.0%

**🎯 ATM選擇權篩選**（從Deribit獲取）：
```
執行價格    ATM距離   隱含波動率   流動性評分   權重排序
$114,000    $240     46.2%       0.956       1 (最佳ATM)
$115,000    $1,240   46.1%       0.977       2
$112,000    $1,760   46.5%       0.973       3  
$116,000    $2,240   46.0%       0.965       4
$110,000    $3,760   46.8%       0.977       5
```

**⚡ 多合約Black-Scholes計算過程**：

**步驟1**：各合約理論定價
```
Strike $114,000 (σ=46.2%): Call折扣=13.23%, Put折扣=12.45%
Strike $115,000 (σ=46.1%): Call折扣=12.82%, Put折扣=12.91%
Strike $112,000 (σ=46.5%): Call折扣=14.10%, Put折扣=11.59%
Strike $116,000 (σ=46.0%): Call折扣=12.42%, Put折扣=13.38%
Strike $110,000 (σ=46.8%): Call折扣=15.01%, Put折扣=10.76%
```

**步驟2**：流動性加權平均
```
總權重 = 0.956 + 0.977 + 0.973 + 0.965 + 0.977 = 4.848

加權Call折扣 = (13.23×0.956 + 12.82×0.977 + 14.10×0.973 + 12.42×0.965 + 15.01×0.977) ÷ 4.848
             = 13.52%

加權Put折扣 = (12.45×0.956 + 12.91×0.977 + 11.59×0.973 + 13.38×0.965 + 10.76×0.977) ÷ 4.848
            = 12.22%
```

**步驟3**：最終結果計算
```
年化Call折扣率 = 13.52% × (365 ÷ 180) = 27.41%
年化Put折扣率 = 12.22% × (365 ÷ 180) = 24.78%
合理購買價格 = $113,760 - 加權Call價格 = $98,382
```

**💡 結果解釋**：
- **Call折扣（機會成本）**：13.52% - 鎖倉期間錯過上漲潛在收益的代價
- **Put折扣（保險成本）**：12.22% - 為防止下跌所需支付的保險費用
- **年化折扣率**：27.41% - 以Call折扣為主的年化機會成本
- **合理購買價格**：$98,382 - 考慮機會成本後的公平價格

### 關鍵問題解析

**🎯 為什麼選擇多個ATM選擇權？**

1. **提高計算準確性**
   - 單一合約可能存在定價偏差或流動性問題
   - 多合約加權平均能減少個別合約的影響，提供更穩定的結果

2. **ATM區域最可靠**
   - Strike價格接近現貨價格的合約時間價值最純粹
   - 避免深度價內/價外選擇權的定價扭曲和流動性不足

3. **流動性權重優化**
   - 根據bid-ask價差計算流動性評分
   - 流動性好的合約獲得更高權重，確保結果可靠性

4. **市場預期代表性**
   - ATM選擇權反映市場對未來價格波動的真實預期
   - 多合約覆蓋更廣的執行價格範圍，提高代表性

**📅 如何選擇到期日？**

**時間匹配原則**：選擇權到期日 ≈ 鎖倉到期日

**實際選擇流程**：
```
步驟1：計算目標到期日
今天：2025年1月15日
6個月鎖倉 → 目標：2025年7月15日

步驟2：尋找最接近的Deribit合約
找到：25JUL25 (2025年7月25日) ← 最接近

步驟3：篩選Strike範圍
現貨：$51,000
篩選範圍：±30% → $35,700 - $66,300
保留：$48K, $50K, $52K 等合約

步驟4：選擇ATM合約
├── |51,000 - 48,000| = 3,000
├── |51,000 - 50,000| = 1,000 ← 最小差距，選擇
└── |51,000 - 52,000| = 1,000
```

**🔍 選擇邏輯代碼實現**：
```typescript
// 1. 時間匹配：根據鎖倉期限計算目標到期日
const targetExpiry = lockupPeriodToExpiry(period);
// 例如：'6M' → '25JUL25'

// 2. 篩選相關合約：只保留目標到期日且價格合理的合約
const relevantInstruments = instruments.filter(name => {
  const parsed = parseInstrumentName(name);
  if (parsed.expiry !== targetExpiry) return false;
  
  // 只取strike在現價±30%範圍內的合約
  const strikeDiff = Math.abs(parsed.strike - spotPrice) / spotPrice;
  return strikeDiff <= 0.3;
});

// 3. 選擇ATM：找到最接近現貨價格的Strike
const atmOption = optionsData.reduce((closest, current) => {
  const closestDiff = Math.abs(closest.strike - spotPrice);
  const currentDiff = Math.abs(current.strike - spotPrice);
  return currentDiff < closestDiff ? current : closest;
});
```

### 參數設定
- **無風險利率(r)**：5% (可調整)
- **時間到期(T)**：鎖倉天數 / 365
- **Strike選擇**：最接近現貨價格的行權價（ATM）
- **到期日選擇**：最接近鎖倉期限的合約
- **Call/Put價格**：使用市場中間價 (Bid+Ask)/2

**適用場景**：選擇權市場活躍，ATM合約流動性充足時
**優點**：多合約加權提高準確性，反映真實市場預期，包含完整波動率信息
**限制**：依賴選擇權市場流動性，需要足夠的ATM合約數量

## Call vs. Put 折扣分析：雙重視角評估

### 📊 折扣率意義對照

| 比較面向 | Call折扣（機會成本） | Put折扣（保險成本） |
|---------|------------------|------------------|
| **經濟含義** | 鎖倉期間錯過上漲潛在收益的代價 | 為防止下跌損失所需支付的保險費用 |
| **投資情境** | 長期看多，擔心錯過牛市行情 | 長期持有，擔心價格大幅下跌 |
| **應用場景** | Staking收益、鎖倉挖礦、流動性提供 | 風險對沖、保本產品、下跌保護 |
| **計算方式** | 理論Call價格 ÷ 現貨價格 × 100% | 理論Put價格 ÷ 現貨價格 × 100% |

### 🎯 實務應用建議

**主要指標選擇**：
- **重視機會成本** → 關注 **Call折扣率**
  - 適合看多投資者，評估鎖倉是否划算
  - 反映市場對上漲預期的定價

- **重視風險控制** → 參考 **Put折扣率** 
  - 適合風險厭惡投資者，評估保護成本
  - 反映市場對下跌風險的定價

**綜合分析**：
- **Call > Put 折扣**：市場預期上漲概率大於下跌，鎖倉機會成本較高
- **Put > Call 折扣**：市場預期下跌風險較大，保險需求較高
- **雙指標並用**：提供更全面的風險-收益評估

## 技術架構

- **前端框架**：Next.js 14 (App Router)
- **開發語言**：TypeScript
- **樣式系統**：Tailwind CSS
- **數據源**：
  - CoinGecko API (現貨價格)
  - Deribit API (選擇權數據)
- **部署平台**：Railway

## 安裝與運行

### 本地開發

```bash
# 安裝依賴
npm install

# 啟動開發服務器
npm run dev

# 在瀏覽器打開 http://localhost:3000
```

### 建置部署

```bash
# 建置生產版本
npm run build

# 啟動生產服務器
npm start
```

### 部署到Railway

1. 將代碼推送到GitHub
2. 在Railway創建新專案並連接repository
3. Railway自動檢測Next.js並部署
4. 獲得部署URL

## 使用指南

### 基本操作
1. **選擇幣種**：點擊BTC或ETH
2. **設定期限**：選擇3M/6M/1Y/2Y
3. **更新數據**：點擊「更新價格與數據」
4. **查看結果**：系統顯示年化折扣率和合理價格

### 高級功能
5. **啟用調試模式**：勾選調試選項查看詳細計算過程
6. **數據驗證**：在調試面板查看原始數據和品質檢查

## 調試功能

### 🔍 調試模式特色

#### 實時處理進度
- ✅ 完成步驟 (綠色)
- 🔄 處理中 (藍色脈動)
- ❌ 失敗步驟 (紅色)
- ⏱️ 執行時間統計

#### 三層調試視圖

**📊 概覽標籤**
- API調用狀態和耗時
- 計算參數 (無風險利率、鎖倉天數)
- 數據品質警告

**🔄 計算步驟標籤**
- 5個主要計算階段的詳細追蹤
- 每步驟的輸入參數、輸出結果
- 使用公式和執行時間
- 錯誤信息 (如有)

**📄 原始數據標籤**
- CoinGecko API完整響應
- Deribit選擇權鏈數據
- 篩選後的選擇權合約表格

### 🚨 智能品質檢查

#### 自動數據驗證
- 現貨價格合理性檢查
- 選擇權價格異常檢測
- ATM合約可用性驗證
- 合約到期日檢查
- Bid-Ask價差分析

#### 問題診斷建議
- API連接失敗自動重試
- 數據不足時的提示
- 計算異常的解釋說明
- 性能瓶頸識別

## 風險提示

### 數據來源限制
- **選擇權數據**：來自Deribit真實市場，但流動性可能影響準確性
- **API限制**：CoinGecko和Deribit有請求頻率限制

### 使用注意事項
- 本工具僅提供計算數據，不構成投資建議
- 計算結果基於當前市場數據，市場條件變化可能影響準確性
- 用戶需根據自己的風險承受能力和判斷標準做決策
- 鎖倉投資存在流動性風險，請充分評估

### 最佳實踐建議
- **ATM合約選擇**：系統自動選擇最接近現價的前5個合約，無需手動調整
- **流動性檢查**：關注ATM合約明細中的權重評分，權重越高表示流動性越好
- **調試模式**：啟用調試功能查看ATM篩選過程和各合約計算詳情
- **雙重指標**：同時關注Call折扣（機會成本）和Put折扣（保險成本）
- **定期更新**：市場波動時重新獲取數據以反映最新市場預期

## 開源協議

MIT License

## 總結

### 🎯 技術創新

**ATM多合約加權方法**：使用前5個最接近ATM的選擇權合約，通過流動性權重進行加權平均，提供比單一合約更穩定可靠的結果。

**Black-Scholes理論定價**：基於市場隱含波動率，使用經典期權定價模型計算理論Call和Put價格，確保計算的理論基礎。

**方差外推技術**：對中長期合約使用線性外推調整隱含波動率，解決長期合約流動性不足的問題。

### 📊 雙重分析視角

**Call折扣（機會成本）**：量化鎖倉期間錯過上漲潛在收益的代價，適合評估看多投資策略的機會成本。

**Put折扣（保險成本）**：衡量為防止下跌所需支付的保險費用，適合評估風險對沖的成本效益。

### 💡 實務應用價值

透過同時計算並解讀Call與Put折扣，從「上漲機會成本」與「下跌保險成本」兩個維度，全面評估BTC/ETH鎖倉方案的合理性：

- **機會成本導向**：Call折扣rate > 預期Staking收益率 → 鎖倉機會成本較高
- **風險控制導向**：Put折扣率 < 可接受的保險成本 → 鎖倉提供下跌保護價值
- **綜合評估**：結合兩個指標與個人風險偏好做出投資決策

---

*本工具使用ATM多合約加權Black-Scholes定價法，為加密貨幣鎖倉token提供科學的折扣率計算，供用戶參考和分析使用。*